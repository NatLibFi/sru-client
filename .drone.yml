---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  #- name: npm
  #  image: plugins/npm
  #  settings:
  #    registry: 'https://registry.npmjs.org/'
  #    token:
  #      from_secret: npm_token
  #  when:
  #    event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - next

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish:dev
    pull: always
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: ssh_key
      git_ssh_key:
        from_secret: gpg_key
---        
kind: secret
name: npm_token
data: +R/O9PfxeAmnUXB/QYrqugUdxU8sWXfRJRaLD2wf3NUjmDVUbGUoAh00xsmSYMJApYEf+GOU/2xS00bIW5RD7A==
---
kind: secret
name: ssh_key
data: jN3W2FFLHsinACEypILgQun/9PmGFOt799FINQfPbnZoNmK9iJB7TvGSYeUgCMAuCbJdQW/IF9eEwhc/wE1ypYynXeMhQB5z2RMeRAxUkRwZRNQ0o52OIVAtm4VJOFg/2dxHe+uZFkdZqp7M1y2miGrzVQO5F1ODIL5V7X8HYKsnWOpIyYhdZJl+CuNUTMNHqCKppSVgwYgK6TxofPYCLoFlUP/m/wmkxWgA0jqCDcesOoC6LRDBWUuidRDi0WV6shuH+Z7avPzeB3/Mg2EbWELSby39HATcyQHBHNxLTagrUNxkcAHL5LPN5U8lsEhPzu+89meVjgRD9xEHYesimrAPscgWe0P5VtLHwGf4n3hOraG2MBH5UyOfKSys8dBGtI/tqmMglpvDGM6IY1d80ut1kpmgk6Nocoh5rSgaogRuLENngPa/9CDoRcCA8NBbbQqHZnGo1/cprVnw8HWGcQPUZLsAIt7Fgu9/aXZYRnxubp7rXDe//lP8gCWrCsRC9cCWJkTRKeQiX+yUpKS0CnVTtzv+T9loPNzLIvbIQTvMhzueM2c3zvN/AymJG9RP2ZsW1SfH8pDVWDa7c/4u+1lBqirE4G4+FH+5EsQfgQvBXfq8gLfpju+Aaby7jWzv0J0dTTjDDbmT6Ea8gJFxPV0MIZ8IppqyGqchQ+R0NTf3lncDlO0hvUdjahR1v38J6VlA91OqwTcBu/NF4RfNaFnCODLaj/boTSk31wvEbllTCsCeY594OjYMxzR28X9Ymn2mU4y9iDuyb+AKvQABcxTB+f0A+/AGY2E+2fH84rSs5HrGxvyubsHxI1rzB2f5Gy7cliCiJp/YC04C5f64PdJ4GgoXL9SLmUaf7HF63xQ61l/4HBbI1/5r5MUFz7wYdYmpUXTU4I+r4YtQLykYYYSmW0IdVDdmVd+X9PQYCWmCo0OXJymgqOMmNVhXdGlI6XrgpRhIf3GrP8QfV/GlvYDXQm9LoJLsA0dY6JhxUWyGHAW3jXuj7WhEPGrqzamzDz6c+sQ2iyWOFPjbAhYS7aSTDkjGqErRwz2QqbQGWuZohpE0AKgHC+qtup0L1GLc4+7RQWHZouxEZeS7GrmhBlXd/3lTv3dR0FUmGGHAOOlJ+94f/hJSkomEm4dIvwC/1lurUm45+sfvPlO4XDG286Z+en+C81vkJZ6jH6t2207CDtXDBImA3aGYIxKumUc+Ll/FakcIIlxMQavhQimfdLCWjiTdNjFo4nAsgiaGp1mpdU7AD5eVaZs8aNaPoUNOP0JXO6RLtXvzdX5AoqdYw9L+cFwp+2AED6oWCSgOmMtSnavGmr09QGnvnaWktE/wFvR9Yr2hbrLXzEoSG/SUbbsqlmazocmZDaqjE4YcKiRzWTxYiLRcWSCvmTHrJsbwof5YRfL5tbT7MDNyl0J9TjEo/oJUQ4WZdynWn/TcWcS1htccXTuXg9vZ+TmebqW8PacR9mLkw+QLBJoYR5j2MKq12KMlUC9VM3K87TT/TpcBbPSzXPmvSJh3XRWbC3QKL7F6+aHlpgJXvUG2c+KoZppIP/oKzRiKavWJwUY+U5FaCPhvqC8ElUqT+OfGZr+Prz8sPt+NY8hFgAelOP7uXQeMjXWTDL5ujRmMePegWyAdZStQdibD1flnwvJsowmTW0MV3AMiES9Euqd3Wp8oNKwCw/+iGKNIo0b3UfRXDoBejOLC4j0+D53gH+OV6hUZifWQMziBX1vLfjxlkQJaVnLPfbPvRaC2TDwXOz6EZnbJFIP4Vzh4Z9V0k1Siy/kexjc/HpsQED/bA8PtJtX+YyDq7wsc9LsaMbWbdYbfTKtS4jwM2CV2pePCtTwSgwkUP2eXHvDsOpoHIhjg8TV+YnjhefQZS4MWpuB3GTgNlZs1gluK+pjkkWhMWB+DqWKgdBpSjf+5foVDURQ8SgdUja7xWkCpWZBc12iZFSkTkIft+JgknW9HNYaM1yp6MOoGe+pBPKM8zVafMO1odgoJChX40mD+FAwK1/daO0NklGd6xx/11ys4H0Zx5Wq4KkOxLty0zJJ4N5ZgAml3eRBvAP+4/qDfo6pFtjl7s/LFauuGiRI71Ji3WICfiyUj64aJlkQ6jygP7DFt+hQwWrxFbsrh635B0VEDXf60Pcb0HehV4UK7ugAOpjk0t3WwaLAFDSPRfJwy3mJcySH0RAf6DLSU4HhMzybCCDMZ50cFJLfJkxtooQQ8J4BSMHMaiWWMAia6NATkgcJSA1zZgqPFJtjFEj8j3e1q9D4ZqcEN0sDt9bLAIN/cyvtgl1bYclyq8lbes0MUCbfFAVRBlNJBipaOzTascL+2d11TUoO3AYTkNeN7TOQQqhpn4ddauJqDjn7dxeudbuOhUKPrGjBmj+2Y+OGecJLape/f1ZoI9WwPtX7QBfXMhGAujgJI2QW12lcEOtdzpa2KMck3h7ladVswZJ4ExCirSTPMH7PqD/qsRqZGbewcGf9bZmEX251FB+KzJnhjIvhms4y7tFZUWHReD8o2c/ZkMo6xPqNdZhfCwCze8a1j5mMhccnpUR5DPuJz8ebB6+4weTRfTCsyXK0Z/E3bMfGgtjwWsSvQLqbu5k/IlFlfsKxdhmqH4hiqxRWntLoW8BahC8ZwtFXzg5Ox4kvmDpNKk/LTrMpBGNDguXzQKV663sqenHaWg88DOcHIGSWRGAlvtK2FgpYCczPGZ5EkNoBBcy8gQ+H7AF0eX+jkFUGweY2WTQ2UlSggxkxsnbwB8Ps1TLHu5vQrLbiFAMoZu/bSXGDoWS7TSbMsQCB4vJzmgPsrfMUNBK+8AH2JvjzLGMCkwd7+sHXr/27+Pbx/W/w9aELgFzzcAOHewq896H72jS83Cy7cpn/xkA02Ns8xcTiX/5DSsUEBlPpkSlNFK+Im05LV3BCFWG6Tq9CxHx2g9tq7GELWO7mPRVuT4BneZvxSHQPQp40EVPUIxVxYzGT96GLWH2ocdSCcVt3FnUI68FRsxf4Ds6DtMVW5lY3FYrI=
---
kind: secret
name: gpg_key
data: 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