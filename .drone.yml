---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  #- name: npm
  #  image: plugins/npm
  #  settings:
  #    registry: 'https://registry.npmjs.org/'
  #    token:
  #      from_secret: npm_token
  #  when:
  #    event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - next

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish:dev
    pull: always
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: github_deploy_key
---        
kind: secret
name: npm_token
data: +R/O9PfxeAmnUXB/QYrqugUdxU8sWXfRJRaLD2wf3NUjmDVUbGUoAh00xsmSYMJApYEf+GOU/2xS00bIW5RD7A==
---
kind: secret
name: github_deploy_key
data: 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