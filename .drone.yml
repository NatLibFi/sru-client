---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  #- name: npm
  #  image: plugins/npm
  #  settings:
  #    registry: 'https://registry.npmjs.org/'
  #    token:
  #      from_secret: npm_token
  #  when:
  #    event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - next

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish:dev
    pull: always
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: github_deploy_key
---        
kind: secret
name: npm_token
data: +R/O9PfxeAmnUXB/QYrqugUdxU8sWXfRJRaLD2wf3NUjmDVUbGUoAh00xsmSYMJApYEf+GOU/2xS00bIW5RD7A==
---
kind: secret
name: github_deploy_key
#data: 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
data: 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