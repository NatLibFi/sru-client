---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  #- name: npm
  #  image: plugins/npm
  #  settings:
  #    registry: 'https://registry.npmjs.org/'
  #    token:
  #      from_secret: npm_token
  #  when:
  #    event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - next

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish:dev
    pull: always
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: github_deploy_key
---        
kind: secret
name: npm_token
data: +R/O9PfxeAmnUXB/QYrqugUdxU8sWXfRJRaLD2wf3NUjmDVUbGUoAh00xsmSYMJApYEf+GOU/2xS00bIW5RD7A==
---
kind: secret
name: github_deploy_key
data: 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