---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:
  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  #- name: npm
  #  image: plugins/npm
  #  settings:
  #    registry: 'https://registry.npmjs.org/'
  #    token:
  #      from_secret: npm_token
  #  when:
  #    event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - next

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish:dev
    pull: always
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: github_deploy_key
---        
kind: secret
name: npm_token
data: +R/O9PfxeAmnUXB/QYrqugUdxU8sWXfRJRaLD2wf3NUjmDVUbGUoAh00xsmSYMJApYEf+GOU/2xS00bIW5RD7A==
---
kind: secret
name: github_deploy_key
data: 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