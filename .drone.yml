---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  #- name: npm
  #  image: plugins/npm
  #  settings:
  #    registry: 'https://registry.npmjs.org/'
  #    token:
  #      from_secret: npm_token
  #  when:
  #    event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - next

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish:dev
    pull: always
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: github_deploy_key
---        
kind: secret
name: npm_token
data: +R/O9PfxeAmnUXB/QYrqugUdxU8sWXfRJRaLD2wf3NUjmDVUbGUoAh00xsmSYMJApYEf+GOU/2xS00bIW5RD7A==
---
kind: secret
name: github_deploy_key
data: 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