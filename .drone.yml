---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test

  - name: check-coverage
    image: node:12
    commands:
      - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/nodejsscan
    commands:
      - python /usr/src/app/cli.py -d dist

  #- name: npm
  #  image: plugins/npm
  #  settings:
  #    registry: 'https://registry.npmjs.org/'
  #    token:
  #      from_secret: npm_token
  #  when:
  #    event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - next

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish:dev
    pull: always
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: github_deploy_key
---        
kind: secret
name: npm_token
data: +R/O9PfxeAmnUXB/QYrqugUdxU8sWXfRJRaLD2wf3NUjmDVUbGUoAh00xsmSYMJApYEf+GOU/2xS00bIW5RD7A==
---
kind: secret
name: github_deploy_key
data: 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